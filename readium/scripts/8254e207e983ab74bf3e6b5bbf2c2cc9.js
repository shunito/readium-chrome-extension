window.Readium={Models:{},Collections:{},Views:{},Routers:{},Utils:{},Init:function(){_router=new Readium.Routers.ViewerRouter;Backbone.history.start({pushState:!0})}};$(function(){window.Readium.Init()});
Readium.FileSystemApi=function(){var f,i=83886080,j=function(a){window.webkitRequestFileSystem(window.PERSITENT,i,function(b){f=b;a&&a(h)},d)},n=function(a){window.webkitStorageInfo.requestQuota(PERSISTENT,i,function(b){i=b;a(h)},function(b){console.log("Error",b);console.log("Exectution will not continue")})},d=function(a){var b="";switch(a.code){case FileError.QUOTA_EXCEEDED_ERR:b="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:b="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:b="SECURITY_ERR";
break;case FileError.INVALID_MODIFICATION_ERR:b="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:b="INVALID_STATE_ERR";break;default:b="Unknown Error"}console.log("Error: "+b)},k=function(a,b){if(b[0]=="."||b[0]=="")b=b.slice(1);a.getDirectory(b[0],{create:!0},function(a){b.length&&k(a,b.slice(1))},d)},o=function(a,b,c,g,e){c.getFile(a,{create:!1},function(d){d.remove(function(){l(a,b,c,g,e)})},function(){l(a,b,c,g,e)})},l=function(a,b,c,g,e){c.getFile(a,{create:!0,exclusive:!1},
function(a){a.createWriter(function(a){var c;a.onwriteend=function(a){g(a)};a.onerror=function(a){e(a)};if(b.webkitRelativePath||b.relativePath){var d=new FileReader;d.onload=function(b){c=new WebKitBlobBuilder;c.append(b.target.result);a.write(c.getBlob())};d.readAsArrayBuffer(b)}else c=new WebKitBlobBuilder,typeof b==="string"?(c.append(b),a.write(c.getBlob("text/plain"))):(d=new Uint8Array(b),c.append(d.buffer),a.write(c.getBlob()))},e)},e)},m=function(a,b,c,d,e){if(a[0]==="."||a[0]==="")a=a.slice(1);
a.length===1?o(a[0],b,c,d,e):c.getDirectory(a[0],{create:!0},function(c){a=a.slice(1);m(a,b,c,d,e)},e)},h={writeFile:function(a,b,c,d){a=a.split("/");m(a,b,f.root,c,d)},getFileSystem:function(){return f},readEntry:function(a,b,c){a.file(function(d){var e=new FileReader;e.onloadend=function(){this.result?b(this.result,a):c&&c()};e.readAsText(d)},c||d)},readTextFile:function(a,b,c){var g=this;f.root.getFile(a,{},function(a){g.readEntry(a,b,c)},c||d)},rmdir:function(a){f.root.getDirectory(a,{},function(a){a.removeRecursively(function(){console.log("Directory removed.")},
d)},d)},getFsUri:function(a,b,c){f.root.getFile(a,{create:!0,exclusive:!1},function(a){b(a.toURL())},c||d)},mkdir:k,genericFsErrorHandler:d};return function(a){if(f)return a(h),h;webkitStorageInfo.queryUsageAndQuota(webkitStorageInfo.PERSITENT,function(b,c){c>0?j(a):n(function(){j(a)})})}}();
Readium.Utils.setCookie=function(d,a,b){var c=new Date;c.setDate(c.getDate()+b);a=escape(a)+(b==null?"":"; expires="+c.toUTCString());document.cookie=d+"="+a};Readium.Utils.getCookie=function(d){var a,b,c,e=document.cookie.split(";");for(a=0;a<e.length;a++)if(b=e[a].substr(0,e[a].indexOf("=")),c=e[a].substr(e[a].indexOf("=")+1),b=b.replace(/^\s+|\s+$/g,""),b==d)return unescape(c)};Readium.Utils.trimString=function(d){return d.replace(/^\s+|\s+$/g,"")};
BBFileSystemSync=function(a,b,c){if(!b.file_path)throw"Cannot sync the model to the fs without a path";switch(a){case "read":Readium.FileSystemApi(function(a){a.readTextFile(b.file_path,function(a){c.success(a)},function(a){c.error(a)})});break;case "create":throw"Not yet implemented";case "update":throw"Not yet implemented";case "delete":throw"Not yet implemented";}return null};
Readium.Models.AlternateStyleTagSelector=Backbone.Model.extend({initialize:function(){},activateAlternateStyleSet:function(b,a){var d,c=[];if(b.length===0)return a;d=$("link[rel*='stylesheet']",a);if(d.length===0)return a;d=this._storeOriginalAttributes(d);c=this._getStyleSetTitles(d);c=this._getStyleSetTitleToActivate(d,c,b);if(c===null)return a;this._activateStyleSet(d,c);return a},_activateStyleSet:function(b,a){b.each(function(){$styleSheet=$(this);$styleSheet.attr("rel","stylesheet");$styleSheet.attr("title")===
void 0?$styleSheet[0].disabled=!1:$.trim($styleSheet.attr("title"))===a?($styleSheet[0].disabled=!0,$styleSheet[0].disabled=!1):$styleSheet[0].disabled=!0});return b},_storeOriginalAttributes:function(b){var a;b.each(function(){a=$(this);a.data("orig-rel")===void 0&&a.attr("data-orig-rel",a.attr("rel"))});return b},_getStyleSetTitleToActivate:function(b,a,d){var c=[],g,e,h,f=[];for(g=0;g<a.length;g+=1)e=b.filter("link[title='"+a[g]+"']"),e=this._removeMutuallyExclusiveAltTags(e),c.push({numAltTagMatches:this._getNumAltStyleTagMatches(e,
d),styleSetTitle:a[g]});h=_.max(c,function(a){return a.numAltTagMatches}).numAltTagMatches;if(h===0)return null;_.each(c,function(a){a.numAltTagMatches===h&&f.push(a.styleSetTitle)});if(f!==1)for(a=0;a<f.length;a++)if(e=b.filter("link[title='"+f[a]+"']"),$.trim($(e[0]).attr("data-orig-rel"))==="stylesheet")return f[a];return f[0]},_getStyleSetTitles:function(b){var a=[];b.each(function(){var b=$(this).attr("title");_.include(a,b)||a.push(b)});return a},_getNumAltStyleTagMatches:function(b,a){var d=
0,c;for(c=0;c<a.length;c+=1)b.filter("link[class*='"+a[c]+"']").length>0&&d++;return d},_removeMutuallyExclusiveAltTags:function(b){var a;b.filter("link[class*='night']").length>0&&b.filter("link[class*='day']").length>0&&b.each(function(){a=$(this);a.filter(".night").length>0&&a.toggleClass("night");a.filter(".day").length>0&&a.toggleClass("day")});b.filter("link[class*='vertical']").length>0&&b.filter("link[class*='horizontal']").length>0&&b.each(function(){a=$(this);a.filter(".vertical").length>
0&&a.toggleClass("vertical");a.filter(".horizontal").length>0&&a.toggleClass("horizontal")});return b}});
Readium.Utils.Guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var b=Math.random()*16|0;return(d=="x"?b:b&3|8).toString(16)})};
Readium.Utils.LocalStorageAdaptor=function(d){var b,f=function(){localStorage.setItem(d,JSON.stringify(b))};return function(h,a,e){var c,g=localStorage.getItem(d);b=g&&JSON.parse(g)||{};switch(h){case "read":c=a.id?b[a.id]:_.values(b);break;case "create":if(!a.id)a.id=a.attributes.id=guid();b[a.id]=a;f();c=a;break;case "update":b[a.id]=a;f();c=a;break;case "delete":delete b[a.id],f(),c=a}c?e.success&&e.success(c):e.error&&e.error("Record not found")}};
Readium.Models.AlternateStyleTagSelector=Backbone.Model.extend({initialize:function(){},activateAlternateStyleSet:function(b,a){var d,c=[];if(b.length===0)return a;d=$("link[rel*='stylesheet']",a);if(d.length===0)return a;d=this._storeOriginalAttributes(d);c=this._getStyleSetTitles(d);c=this._getStyleSetTitleToActivate(d,c,b);if(c===null)return a;this._activateStyleSet(d,c);return a},_activateStyleSet:function(b,a){b.each(function(){$styleSheet=$(this);$styleSheet.attr("rel","stylesheet");$styleSheet.attr("title")===
void 0?$styleSheet[0].disabled=!1:$.trim($styleSheet.attr("title"))===a?($styleSheet[0].disabled=!0,$styleSheet[0].disabled=!1):$styleSheet[0].disabled=!0});return b},_storeOriginalAttributes:function(b){var a;b.each(function(){a=$(this);a.data("orig-rel")===void 0&&a.attr("data-orig-rel",a.attr("rel"))});return b},_getStyleSetTitleToActivate:function(b,a,d){var c=[],g,e,h,f=[];for(g=0;g<a.length;g+=1)e=b.filter("link[title='"+a[g]+"']"),e=this._removeMutuallyExclusiveAltTags(e),c.push({numAltTagMatches:this._getNumAltStyleTagMatches(e,
d),styleSetTitle:a[g]});h=_.max(c,function(a){return a.numAltTagMatches}).numAltTagMatches;if(h===0)return null;_.each(c,function(a){a.numAltTagMatches===h&&f.push(a.styleSetTitle)});if(f!==1)for(a=0;a<f.length;a++)if(e=b.filter("link[title='"+f[a]+"']"),$.trim($(e[0]).attr("data-orig-rel"))==="stylesheet")return f[a];return f[0]},_getStyleSetTitles:function(b){var a=[];b.each(function(){var b=$(this).attr("title");_.include(a,b)||a.push(b)});return a},_getNumAltStyleTagMatches:function(b,a){var d=
0,c;for(c=0;c<a.length;c+=1)b.filter("link[class*='"+a[c]+"']").length>0&&d++;return d},_removeMutuallyExclusiveAltTags:function(b){var a;b.filter("link[class*='night']").length>0&&b.filter("link[class*='day']").length>0&&b.each(function(){a=$(this);a.filter(".night").length>0&&a.toggleClass("night");a.filter(".day").length>0&&a.toggleClass("day")});b.filter("link[class*='vertical']").length>0&&b.filter("link[class*='horizontal']").length>0&&b.each(function(){a=$(this);a.filter(".vertical").length>
0&&a.toggleClass("vertical");a.filter(".horizontal").length>0&&a.toggleClass("horizontal")});return b}});
Readium.Models.ManifestItem=Backbone.Model.extend({parseMetaTags:function(){var a;typeof this.get("meta_width")==="undefined"&&(this.isSvg()?a=this.parseViewboxTag():this.isImage()||(a=this.parseViewportTag()),a&&this.set({meta_width:a.width,meta_height:a.height}))},getContentDom:function(){var a=this.get("content");if(a)return(new window.DOMParser).parseFromString(a,"text/xml")},parseViewportTag:function(){var a=this.getContentDom();if(a){a=a.getElementsByName("viewport")[0];if(!a)return null;for(var a=
a.getAttribute("content"),a=a.replace(/\s/g,""),a=a.split(","),b={},c,d=0;d<a.length;d++)c=a[d].split("="),c.length===2&&(b[c[0]]=c[1]);b.width=parseFloat(b.width,10);b.height=parseFloat(b.height,10);return b}},parseViewboxTag:function(){var a=this.getContentDom();if(a){var a=a.documentElement.getAttribute("viewBox").split(/,?\s+|,/),b={};b.width=parseFloat(a[2],10);b.height=parseFloat(a[3],10);return b}},resolvePath:function(a){return this.collection.packageDocument.resolvePath(a)},resolveUri:function(a){return this.collection.packageDocument.resolveUri(a)},
isSvg:function(){return this.get("media_type")==="image/svg+xml"},isImage:function(){var a=this.get("media_type");return a&&a.indexOf("image/")>-1?a!=="image/svg+xml":!1},loadContent:function(){var a=this,b=this.resolvePath(this.get("href"));Readium.FileSystemApi(function(c){c.readTextFile(b,function(b){a.set({content:b})},function(){console.log("Failed to load file: "+b)})})}});
Readium.Models.SpineItem=Readium.Models.ManifestItem.extend({initialize:function(){this.isFixedLayout()&&(this.on("change:content",this.parseMetaTags,this),this.loadContent())},buildSectionJSON:function(a,b){if(!a)return null;var c=Object.create(null);c.width=this.get("meta_width")||0;c.height=this.get("meta_height")||0;c.uri=this.packageDocument.resolveUri(a.get("href"));c.page_class=this.getPageSpreadClass(a,b);return c},toJSON:function(){this.isFixedLayout()&&this.parseMetaTags();var a={};a.width=
this.get("meta_width")||0;a.height=this.get("meta_height")||0;a.uri=this.resolveUri(this.get("href"));a.page_class=this.getPageSpreadClass();return a},getPageSpreadClass:function(){var a=this.collection.packageDocument.get("book"),b=this.get("spine_index");return a.get("apple_fixed")?b===0?"center_page":b%2===1&&b===this.collection.length?"center_page":b%2===0?"right_page":"left_page":this.get("page_spread")?(a=this.get("page_spread"),a==="left"?"left_page":a==="right"?"right_page":"center_page"):
this.get("page_prog_dir")==="rtl"?b%2===0?"right_page":"left_page":b%2===0?"left_page":"right_page"},isFixedLayout:function(){return this.isSvg()||this.isImage()?!0:typeof this.get("fixed_flow")!=="undefined"?this.get("fixed_flow"):this.collection.isBookFixedLayout()},getPageView:function(){if(!this.view)this.view=this.isImage()?new Readium.Views.ImagePageView({model:this}):new Readium.Views.FixedPageView({model:this});return this.view},hasMediaOverlay:function(){return!!this.get("media_overlay")&&
!!this.getMediaOverlay()},getMediaOverlay:function(){return this.collection.getMediaOverlay(this.get("media_overlay"))}});Readium.Collections.ManifestItems=Backbone.Collection.extend({model:Readium.Models.ManifestItem,initialize:function(a,b){this.packageDocument=b.packageDocument}});
Readium.Collections.Spine=Backbone.Collection.extend({model:Readium.Models.SpineItem,initialize:function(a,b){this.packageDocument=b.packageDocument},isBookFixedLayout:function(){return this.packageDocument.get("book").isFixedLayout()},getMediaOverlay:function(a){return this.packageDocument.getMediaOverlayItem(a)}});
Readium.Models.PackageDocumentParser=function(a){this.uri_obj=a};
Readium.Models.PackageDocumentParser.JathTemplate={metadata:{id:"//def:metadata/dc:identifier",epub_version:"//def:package/@version",title:"//def:metadata/dc:title",author:"//def:metadata/dc:creator",publisher:"//def:metadata/dc:publisher",description:"//def:metadata/dc:description",rights:"//def:metadata/dc:rights",language:"//def:metadata/dc:language",pubdate:"//def:metadata/dc:date",modified_date:"//def:metadata/def:meta[@property='dcterms:modified']",layout:"//def:metadata/def:meta[@property='rendition:layout']",
spread:"//def:metadata/def:meta[@property='rendition:spread']",orientation:"//def:metadata/def:meta[@property='rendition:orientation']",ncx:"//def:spine/@toc",page_prog_dir:"//def:spine/@page-progression-direction",active_class:"//def:metadata/def:meta[@property='media:active-class']"},manifest:["//def:item",{id:"@id",href:"@href",media_type:"@media-type",properties:"@properties",media_overlay:"@media-overlay"}],spine:["//def:itemref",{idref:"@idref",properties:"@properties",linear:"@linear"}],bindings:["//def:bindings/def:mediaType",
{handler:"@handler",media_type:"@media-type"}]};
Readium.Models.PackageDocumentParser.prototype.parse=function(a){var c;c=typeof a==="string"?(new window.DOMParser).parseFromString(a,"text/xml"):a;Jath.resolver=function(a){return{def:"http://www.idpf.org/2007/opf",dc:"http://purl.org/dc/elements/1.1/"}[a]};a=Jath.parse(Readium.Models.PackageDocumentParser.JathTemplate,c);a.paginate_backwards=this.paginateBackwards(c);if(c=this.getCoverHref(c))a.metadata.cover_href=this.resolveUri(c);if(a.metadata.layout==="pre-paginated")a.metadata.fixed_layout=
!0;a.manifest=new Readium.Collections.ManifestItems(a.manifest,{packageDocument:this});a.mo_map=this.resolveMediaOverlays(a.manifest);a.spine=this.parseSpineProperties(a.spine);return a};
Readium.Models.PackageDocumentParser.prototype.getCoverHref=function(a){var c,b;c=a.getElementsByTagName("manifest")[0];b=$('item[properties~="cover-image"]',c);if(b.length===1&&b.attr("href"))return b.attr("href");a=$('meta[name="cover"]',a);b=a.attr("content");if(a.length===1&&b&&(b=$('item[id="'+b+'"]',c),b.length===1&&b.attr("href")))return b.attr("href");b=$("#cover",c);return b.length===1&&b.attr("href")?b.attr("href"):null};
Readium.Models.PackageDocumentParser.prototype.parseSpineProperties=function(a){for(var c=function(a){for(var b={},a=a.split(" "),c=0;c<a.length;c++){if(a[c]==="rendition:page-spread-center")b.page_spread="center";if(a[c]==="page-spread-left")b.page_spread="left";if(a[c]==="page-spread-right")b.page_spread="right";if(a[c]==="page-spread-right")b.page_spread="right";if(a[c]==="rendition:layout-reflowable")b.fixed_flow=!1;if(a[c]==="rendition:layout-pre-paginated")b.fixed_flow=!0}return b},b=0;b<a.length;b++){var e=
c(a[b].properties);_.extend(a[b],e)}return a};Readium.Models.PackageDocumentParser.prototype.resolveMediaOverlays=function(a){var c=this,b={};a.forEach(function(a){if(a.get("media_type")==="application/smil+xml"){var d=c.resolveUri(a.get("href")),f=new Readium.Models.MediaOverlay;f.setUrl(d);f.fetch();b[a.id]=f}});return b};Readium.Models.PackageDocumentParser.prototype.paginateBackwards=function(a){return $("spine",a).attr("page-progression-direction")==="ltr"};
Readium.Models.PackageDocumentParser.prototype.crunchSpine=function(a,c){var b=this,e=-1,d=_.map(a,function(a){e+=1;var d=c.find(function(b){if(b.get("id")===a.idref)return b}),g=b.get("book");return _.extend({},a,d.attributes,{spine_index:e},{page_prog_dir:g.get("page_prog_dir")})});return new Readium.Collections.Spine(d,{packageDocument:this})};Readium.Models.PackageDocumentParser.prototype.resolveUri=function(a){uri=new URI(a);return uri.resolve(this.uri_obj).toString()};
Readium.Models.PackageDocument=Backbone.Model.extend({initialize:function(a){var b=this;if(a.file_path)this.file_path=a.file_path,Readium.FileSystemApi(function(a){a.getFsUri(b.file_path,function(a){b.uri_obj=new URI(a)})});else throw"This class cannot be synced without a file path";this.on("change:spine_position",this.onSpinePosChanged)},onSpinePosChanged:function(){this.get("spine_position")>=this.previous("spine_position")?this.trigger("increased:spine_position"):this.trigger("decreased:spine_position")},
validate:function(a){if(!a.manifest&&!this.get("manifest"))return"ERROR: All ePUBs must have a manifest";var b=a.spine||this.get("spine");if(!b)return"ERROR: All ePUBs must have a spine";if(a.spine_position<0||a.spine_position>=b.length)return"ERROR: invalid spine position"},sync:BBFileSystemSync,defaults:{spine_position:0},getManifestItemById:function(a){return this.get("manifest").find(function(b){if(b.get("id")===a)return b})},getSpineItem:function(a){return this.get("res_spine").at(a)},spineLength:function(){return this.get("res_spine").length},
getNextLinearSpinePostition:function(a){var b=this.get("res_spine");if(a===void 0||a<-1)a=-1;for(;a<b.length-1;)if(a+=1,b.at(a).get("linear")!=="no")return a;return-1},getPrevLinearSpinePostition:function(a){var b=this.get("res_spine");if(a===void 0||a>b.length)a=b.length;for(;a>0;)if(a-=1,b.at(a).get("linear")!=="no")return a;return-1},goToNextSection:function(){this.set({spine_position:this.get("spine_position")+1})},goToPrevSection:function(){this.set({spine_position:this.get("spine_position")-
1})},spineIndexFromHref:function(a){for(var b=this.get("res_spine"),a=this.resolveUri(a).replace(/#.*$/,""),c=0;c<b.length;c++){var d=b.at(c).get("href"),d=this.resolveUri(d).replace(/#.*$/,"");if(d===a)return c}return-1},goToHref:function(a){var b=this.get("spine"),c=this.get("manifest"),d=this,a=d.resolveUri(a).replace(/#.*$/,""),c=c.find(function(b){var c=d.resolveUri(b.get("href")).replace(/#.*$/,"");if(a==c)return b});if(!c)return null;for(var c=c.get("id"),e=0;e<b.length;++e)if(b[e].idref===
c){this.set({spine_position:e},{silent:!0});this._previousAttributes.spine_position=0;this.trigger("change:spine_position");break}},getTocItem:function(){var a=this.get("manifest"),b=this.get("metadata").ncx,c=a.find(function(a){return a.get("properties")==="nav"});return c?c:b&&b.length>0?a.find(function(a){return a.get("id")===b}):null},getMediaOverlayItem:function(a){var b=this.get("mo_map");return b&&b[a]},crunchSpine:function(a,b){var c=this,d=-1,e=_.map(a,function(a){d+=1;var e=b.find(function(b){if(b.get("id")===
a.idref)return b}),f=c.get("book");return _.extend({},a,e.attributes,{spine_index:d},{page_prog_dir:f.get("page_prog_dir")})});return new Readium.Collections.Spine(e,{packageDocument:this})},parse:function(a){a=(new Readium.Models.PackageDocumentParser(this.uri_obj)).parse(a);a.res_spine=this.crunchSpine(a.spine,a.manifest);return a},resolveUri:function(a){uri=new URI(a);return uri.resolve(this.uri_obj).toString()},resolvePath:function(a){var b=this.file_path,a=a.indexOf("../")===0?a.substr(3):a,
c=b.lastIndexOf("/");return b.substr(0,c)+"/"+a}});
Readium.Models.EPUBController=Backbone.Model.extend({initialize:function(){var a=this;this.epub=this.get("epub");this.set("media_overlay_controller",new Readium.Models.MediaOverlayController({epubController:this}));this.paginator=new Readium.Models.PaginationStrategySelector({book:this});this.packageDocument=this.epub.getPackageDocument();this.packageDocument.fetch({success:function(){var b=a.restorePosition();a.set("spine_position",b);b=a.paginator.renderSpineItems(!1);a.set("rendered_spine_items",
b);a.set("has_toc",!!a.packageDocument.getTocItem())}});this.on("change:spine_position",this.savePosition,this);this.on("change:spine_position",this.setMetaSize,this)},save:function(a,b){var c={success:function(){}};_.extend(c,b);var d=this;this.set("updated_at",new Date);this.set("key",this.epub.get("key")+"_epubViewProperties");Lawnchair(function(){this.save(d.toJSON(),c.success)})},defaults:{font_size:10,two_up:!1,full_screen:!1,toolbar_visible:!0,toc_visible:!1,rendered_spine_items:[],current_theme:"default-theme",
current_margin:3},toJSON:function(){return{updated_at:this.get("updated_at"),current_theme:this.get("current_theme"),current_margin:this.get("current_margin"),two_up:this.get("two_up"),font_size:this.get("font_size"),key:this.get("key")}},toggleFullScreen:function(){this.set({full_screen:!this.get("full_screen")})},increaseFont:function(){this.set({font_size:this.get("font_size")+1})},decreaseFont:function(){this.set({font_size:this.get("font_size")-1})},toggleToc:function(){this.set("toc_visible",
!this.get("toc_visible"))},goToHref:function(a){a=a.match(/([^#]*)(?:#(.*))?/);a[1]&&this.setSpinePos(this.packageDocument.spineIndexFromHref(a[1]));a[2]&&this.set({hash_fragment:a[2]})},getToc:function(){var a=this.packageDocument.getTocItem();return a?Readium.Models.Toc.getToc(a,{file_path:this.resolvePath(a.get("href")),book:this}):null},getCurrentSection:function(a){a||(a=0);return this.packageDocument.getSpineItem(this.get("spine_position")+a)},isFixedLayout:function(){return this.epub.isFixedLayout()},
restorePosition:function(){var a=Readium.Utils.getCookie(this.epub.get("key"));return parseInt(a,10)||this.packageDocument.getNextLinearSpinePostition()},savePosition:function(){Readium.Utils.setCookie(this.epub.get("key"),this.get("spine_position"),365)},resolvePath:function(a){return this.packageDocument.resolvePath(a)},hasNextSection:function(){return this.packageDocument.getPrevLinearSpinePostition(this.get("spine_position"))>-1},hasPrevSection:function(){return this.packageDocument.getNextLinearSpinePostition(this.get("spine_position"))>
-1},goToNextSection:function(){var a=this.packageDocument.getNextLinearSpinePostition(this.get("spine_position"));a>-1&&this.setSpinePos(a,!1)},goToPrevSection:function(){var a=this.packageDocument.getPrevLinearSpinePostition(this.get("spine_position"));a>-1&&this.setSpinePos(a,!0)},setSpinePos:function(a,b){if(!(a<0||a>=this.packageDocument.spineLength())){var c=this.get("rendered_spine_items").indexOf(a)>=0?!0:!1;this.set("spine_position",a);this.trigger("FXL_goToPage");c||this.set("rendered_spine_items",
this.paginator.renderSpineItems(b))}},setMetaSize:function(){this.meta_section&&this.meta_section.off("change:meta_height",this.setMetaSize);this.meta_section=this.getCurrentSection();this.meta_section.get("meta_height")&&this.set("meta_size",{width:this.meta_section.get("meta_width"),height:this.meta_section.get("meta_height")});this.meta_section.on("change:meta_height",this.setMetaSize,this)}});
Readium.Models.OptionsPresenter=Backbone.Model.extend({initialize:function(){var a=this.get("book");if(!a)throw"ebook must be set in the constructor";this.resetOptions();a.on("change:font_size",this.resetOptions,this);a.on("change:two_up",this.resetOptions,this);a.on("change:current_theme",this.resetOptions,this);a.on("change:current_margin",this.resetOptions,this)},applyOptions:function(){var a=this.get("book");a.set({font_size:this.get("font_size"),current_theme:this.get("current_theme"),current_margin:this.get("current_margin")});
this.get("two_up")!==a.get("two_up")&&a.set("two_up",!a.get("two_up"));a.save()},resetOptions:function(){var a=this.get("book");this.set({font_size:a.get("font_size"),two_up:a.get("two_up"),current_theme:a.get("current_theme"),current_margin:a.get("current_margin")})}});
Readium.Models.Toc=Backbone.Model.extend({sync:BBFileSystemSync,initialize:function(a){this.file_path=a.file_path;this.book=a.book;this.book.on("change:toc_visible",this.setVisibility,this);this.book.on("change:toolbar_visible",this.setTocVis,this)},handleLink:function(a){this.book.goToHref(a)},setVisibility:function(){this.set("visible",this.book.get("toc_visible"))},hide:function(){this.book.set("toc_visible",!1)},setTocVis:function(){this.book.get("toolbar_visible")||this.book.set("toc_visible",
!1)},defaults:{visible:!1}},{XHTML_MIME:"application/xhtml+xml",XML_MIME:"text/xml",NCX_MIME:"application/x-dtbncx+xml",getToc:function(a,b){var c=a.get("media_type");if(c===Readium.Models.Toc.XHTML_MIME||c===Readium.Models.Toc.XML_MIME)return new Readium.Models.XhtmlToc(b);else if(c===Readium.Models.Toc.NCX_MIME)return new Readium.Models.NcxToc(b)}});
Readium.Models.NcxToc=Readium.Models.Toc.extend({jath_template:{title:"//ncx:docTitle/ncx:text",navs:["//ncx:navMap/ncx:navPoint",{text:"ncx:navLabel/ncx:text",href:"ncx:content/@src"}]},parse:function(a){typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,"text/xml"));Jath.resolver=function(a){return a==="ncx"?"http://www.daisy.org/z3986/2005/ncx/":""};return Jath.parse(this.jath_template,a)},TocView:function(){return new Readium.Views.NcxTocView({model:this})}});
Readium.Models.XhtmlToc=Readium.Models.Toc.extend({parse:function(a){var b={};typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,"text/xml"));b.title=$("title",a).text();b.body=$("body",a);return b},TocView:function(){return new Readium.Views.XhtmlTocView({model:this})}});
Readium.Models.SmilModel=function(){function h(a){m(a);a.childNodes.length>0&&$.each(a.childNodes,function(a,b){h(b)})}function m(a){a.toString=function(){for(var a="<"+this.nodeName,b=0;b<this.attributes.length;b++)a+=" "+this.attributes.item(b).nodeName+"="+this.attributes.item(b).nodeValue;a+=">";return a};if(g.hasOwnProperty(a.tagName))a.render=g[a.tagName];if(i.hasOwnProperty(a.tagName))a.notifyChildDone=i[a.tagName];n(a)}function n(a){a.tagName=="audio"&&($(a).attr("src")!=void 0&&$(a).attr("src",
o($(a).attr("src"),j)),$(a).attr("clipBegin")!=void 0?$(a).attr("clipBegin",k($(a).attr("clipBegin"))):$(a).attr("clipBegin",0),$(a).attr("clipEnd")!=void 0?$(a).attr("clipEnd",k($(a).attr("clipEnd"))):$(a).attr("clipEnd",9999999))}function o(a,c){if(a.indexOf("://")!=-1)return a;var b=c;c[c.length-1]!="/"&&(b=c.substr(0,c.lastIndexOf("/")+1));return b+a}function k(a){var c=0,b=0,d=0;a.indexOf("min")!=-1?b=parseFloat(a.substr(0,a.indexOf("min"))):a.indexOf("ms")!=-1?d=parseFloat(a.substr(0,a.indexOf("ms")))/
1E3:a.indexOf("s")!=-1?d=parseFloat(a.substr(0,a.indexOf("s"))):a.indexOf("h")!=-1?c=parseFloat(a.substr(0,a.indexOf("h"))):(arr=a.split(":"),d=parseFloat(arr.pop()),arr.length>0&&(b=parseFloat(arr.pop()),arr.length>0&&(c=parseFloat(arr.pop()))));return c*3600+b*60+d}NodeLogic={parRender:function(){$.each(this.childNodes,function(a,c){c.hasOwnProperty("render")&&c.render()})},seqRender:function(a){a==null?this.firstElementChild.render():a.render()},audioNotifyChildDone:function(){this.parentNode.notifyChildDone(this)},
parNotifyChildDone:function(a){a.tagName=="audio"&&this.parentNode.notifyChildDone(this)},seqNotifyChildDone:function(a){a.nextElementSibling==null?this==e?l():this.parentNode.notifyChildDone(this):this.render(a.nextElementSibling)}};var g={seq:NodeLogic.seqRender,par:NodeLogic.parRender,body:NodeLogic.seqRender},i={seq:NodeLogic.seqNotifyChildDone,par:NodeLogic.parNotifyChildDone,body:NodeLogic.seqNotifyChildDone,audio:NodeLogic.audioNotifyChildDone,text:function(){}},j=null,l=null,e=null;this.addRenderers=
function(a){g=$.extend(g,a)};this.setUrl=function(a){j=a};this.setNotifySmilDone=function(a){l=a};this.build=function(a){e=a;h(a)};this.render=function(a){a==null||a==void 0||a==e?e.render(null):(this.peekNextAudio(a).isJumpTarget=!0,a.parentNode.render(a))};this.findNodeByAttrValue=function(a,c,b){if(e==null)return null;var d=null,f=c;if(f=="src"||f=="epub:textref"){f=="epub:textref"&&(f="epub\\:textref");var g=b.substr(b.lastIndexOf("/")+1),a=$(e).find(a+"["+f+"]");b==""?d=a[0]:a.each(function(){var a=
$(this).attr(f);if(a!=void 0&&(a=a.substr(a.lastIndexOf("/")+1),a===g))return d=this,!1})}else f!=""&&(a+="["+f,b!=""&&(a+="='"+b+"'"),a+="]"),d=$(e).find(a),d=d.length==0?null:d[0];return d};this.peekNextAudio=function(a){if(a.tagName=="par")return $(a).find("audio")[0];if(a.tagName=="text")return $(a.parentNode).find("audio")[0];for(a=a.parentNode;a.nextElementSibling==null;)if(a=a.parentNode,a==e)return null;return $(a.nextElementSibling).find("audio")[0]}};
Readium.Models.MediaOverlay=Backbone.Model.extend({audioplayer:null,smilModel:null,consoleTrace:!1,url:null,defaults:{current_text_src:null,has_started_playback:!1,is_document_done:!1,is_playing:!1,is_ready:!1},initialize:function(){var a=this;this.audioplayer=new Readium.Models.AudioClipPlayer;this.audioplayer.setConsoleTrace(!1);this.audioplayer.setNotifyOnPause(function(){a.set({is_playing:a.audioplayer.isPlaying()})});this.audioplayer.setNotifyOnPlay(function(){a.set({is_playing:a.audioplayer.isPlaying()})})},
setUrl:function(a){this.url=a},fetch:function(a){this.set({is_ready:!1});a=a||{};a.dataType="xml";Backbone.Model.prototype.fetch.call(this,a)},parse:function(a){var b=this;this.smilModel=new Readium.Models.SmilModel;this.smilModel.setUrl(this.url);this.smilModel.setNotifySmilDone(function(){b.debugPrint("document done");b.set({is_document_done:!0})});this.smilModel.addRenderers({audio:function(){var a=this;b.audioplayer.setNotifyClipDone(function(){a.notifyChildDone()});var c=!1;if(this.hasOwnProperty("isJumpTarget"))c=
this.isJumpTarget,this.isJumpTarget=!1;b.audioplayer.play($(this).attr("src"),parseFloat($(this).attr("clipBegin")),parseFloat($(this).attr("clipEnd")),c)},text:function(){var a=$(this).attr("src");b.debugPrint("Text: "+a);b.set("current_text_src",a)}});this.smilModel.build($(a).find("body")[0]);this.set({is_ready:!0})},startPlayback:function(a){this.get("is_ready")==!1?this.debugPrint("document not ready"):(this.set({is_document_done:!1}),this.set({has_started_playback:!0}),this.smilModel.render(a))},
pause:function(){this.get("is_ready")==!1?this.debugPrint("document not ready"):this.get("has_started_playback")==!1?this.debugPrint("can't pause: playback not yet started"):this.audioplayer.pause()},resume:function(){this.get("is_ready")==!1?this.debugPrint("document not ready"):this.get("has_started_playback")==!1?this.debugPrint("can't resume: playback not yet started"):this.audioplayer.resume()},findNodeByTextSrc:function(a){if(this.get("is_ready")==!1)return this.debugPrint("document not ready"),
null;if(a==null||a==void 0||a=="")return null;var b=this.smilModel.findNodeByAttrValue("text","src",a);b==null&&(b=this.smilModel.findNodeByAttrValue("seq","epub:textref",a));return b},setVolume:function(a){this.get("is_ready")==!1?this.debugPrint("document not ready"):this.audioplayer.setVolume(a)},reset:function(){this.set("current_text_src",null);this.set("has_started_playback",!1)},setConsoleTrace:function(a){this.consoleTrace=a},debugPrint:function(a){this.consoleTrace&&console.log("MediaOverlay: "+
a)}});
Readium.Models.AudioClipPlayer=function(){function m(){function b(){a.removeEventListener("canplay",b);if(e>a.duration)f("File is shorter than specified clipEnd time"),e=a.duration;f("Audio data loaded");j()}f("Loading file "+g);a.setAttribute("src",g);a.addEventListener("canplay",b);a.addEventListener("ended",function(){c!=null&&clearInterval(c);d!=null&&d()})}function j(){if(k==!1&&a.currentTime>h&&a.currentTime<e)i(),a.play();else{a.addEventListener("seeked",b);f("setting currentTime from "+a.currentTime+
"to "+h);a.currentTime=h;var b=function(){a.removeEventListener("seeked",b);i();a.play()}}}function i(){c!=null&&clearInterval(c);c=setInterval(function(){a.currentTime>=e&&(clearInterval(c),f("clip done"),d!=null&&d())},11)}function f(a){l&&console.log("AudioClipPlayer: "+a)}var g=null,h=null,e=null,k=!1,a=new Audio,d=null,l=!1,c=null;this.setNotifyClipDone=function(a){d=a};this.setConsoleTrace=function(a){l=a};this.play=function(b,c,d,i){g=b;h=c;e=d;k=i;f("playing "+g+" from "+h+" to "+e);a==null||
a.getAttribute("src")!=g?m():j()};this.isPlaying=function(){return a==null?!1:!a.paused};this.resume=function(){a!=null&&a.play()};this.pause=function(){a!=null&&a.pause()};this.setNotifyOnPause=function(b){a.addEventListener("pause",function(){b()})};this.setNotifyOnPlay=function(b){a.addEventListener("play",function(){b()})};this.getCurrentTime=function(){return a!=null?a.currentTime:0};this.getCurrentSrc=function(){return g};this.setVolume=function(b){a.volume=b<0?0:b>1?1:b}};
Readium.Models.PaginationStrategySelector=Backbone.Model.extend({renderToLastPage:!1,initialize:function(){this.model=this.get("book");this.zoomer=new Readium.Views.FixedLayoutBookZoomer},renderSpineItems:function(a){var b=this.model;this.v&&this.v.destruct();this.v=b.getCurrentSection().isFixedLayout()?new Readium.Views.FixedPaginationView({model:b,zoomer:this.zoomer}):this.shouldScroll()?new Readium.Views.ScrollingPaginationView({model:b,zoomer:this.zoomer}):new Readium.Views.ReflowablePaginationView({model:b,
zoomer:this.zoomer});return this.rendered_spine_positions=this.v.render(!!a)},shouldScroll:function(){var a=localStorage.READIUM_OPTIONS;return!(a&&JSON.parse(a)||{singleton:{}}).singleton.paginate_everything}});
Readium.Models.Trigger=function(a){a=$(a);this.action=a.attr("action");this.ref=a.attr("ref");this.event=a.attr("ev:event");this.observer=a.attr("ev:observer");this.ref=a.attr("ref")};Readium.Models.Trigger.prototype.subscribe=function(a){var b=this;$("#"+this.observer,a).on(this.event,function(){b.execute(a)})};
Readium.Models.Trigger.prototype.execute=function(a){a=$("#"+this.ref,a);switch(this.action){case "show":a.css("visibility","visible");break;case "hide":a.css("visibility","hidden");break;case "play":a[0].currentTime=0;a[0].play();break;case "pause":a[0].pause();break;case "resume":a[0].play();break;case "mute":a[0].muted=!0;break;case "unmute":a[0].muted=!1;break;default:console.log("do not no how to handle trigger "+this.action)}};
Readium.Views.PaginationViewBase=Backbone.View.extend({el:"#readium-book-view-el",initialize:function(a){this.zoomer=a.zoomer;this.pages=new Readium.Models.ReadiumPagination({model:this.model});this.mediaOverlayController=this.model.get("media_overlay_controller");this.mediaOverlayController.setPages(this.pages);this.mediaOverlayController.setView(this);this.pages.on("change:current_page",this.showCurrentPages,this);this.model.on("change:font_size",this.setFontSize,this);this.model.on("change:two_up",
this.pages.toggleTwoUp,this.pages);this.mediaOverlayController.on("change:mo_text_id",this.highlightText,this);this.mediaOverlayController.on("change:active_mo",this.indicateMoIsPlaying,this);this.bindingTemplate=Handlebars.templates.binding_template},iframeLoadCallback:function(a){this.applyBindings($(a.srcElement).contents());this.applySwitches($(a.srcElement).contents());this.addSwipeHandlers($(a.srcElement).contents());this.injectMathJax(a.srcElement);this.injectLinkHandler(a.srcElement);var b=
this.parseTriggers(a.srcElement.contentDocument);this.applyTriggers(a.srcElement.contentDocument,b);this.mediaOverlayController.pagesLoaded()},activateEPubStyle:function(a){var b;this.model.get("current_theme")==="night-theme"?(b=new Readium.Models.AlternateStyleTagSelector,b.activateAlternateStyleSet(["night"],a)):(b=new Readium.Models.AlternateStyleTagSelector,b.activateAlternateStyleSet([""],a))},setUpMode:function(){var a=this.model.get("two_up");this.$el.toggleClass("two-up",a);this.$("#spine-divider").toggle(a)},
showCurrentPages:function(){var a=this,b=this.model.get("two_up");this.$(".page-wrap").each(function(c){b||(c+=1);$(this).toggleClass("hidden-page",!a.pages.isPageVisible(c))})},destruct:function(){this.pages.off("change:current_page",this.showCurrentPages);this.model.off("change:font_size",this.setFontSize);this.model.off("change:hash_fragment",this.goToHashFragment);this.mediaOverlayController.off("change:mo_text_id",this.highlightText);this.mediaOverlayController.off("change:active_mo",this.indicateMoIsPlaying);
this.resetEl()},linkClickHandler:function(a){a.preventDefault();a=a.srcElement.attributes.href.value;a.match(/^http(s)?:/)?chrome.tabs.create({url:a}):this.model.goToHref(a)},getBindings:function(){var a=this.model.epub.getPackageDocument();return a.get("bindings").map(function(b){b.selector='object[type="'+b.media_type+'"]';b.url=a.getManifestItemById(b.handler).get("href");b.url=a.resolveUri(b.url);return b})},applyBindings:function(a){for(var b=this,c=this.getBindings(),d=0,d=0;d<c.length;d++)$(c[d].selector,
a).each(function(){var a=[],f=$(this),e=f.attr("data");a.push("src="+b.model.packageDocument.resolveUri(e));a.push("type="+c[d].media_type);a=c[d].url+"?"+a.join("&");e=$(b.bindingTemplate({}));e.attr("src",a);f.html(e)})},applyTriggers:function(a,b){for(var c=0;c<b.length;c++)b[c].subscribe(a)},parseTriggers:function(a){var b=[];$("trigger",a).each(function(){b.push(new Readium.Models.Trigger(this))});return b},applySwitches:function(a){$("switch",a).each(function(){var a=!1;$("case",this).each(function(){var c;
if(c=!a)(c=this.attributes["required-namespace"])?c=_.include(["http://www.w3.org/1998/Math/MathML"],c):(console.log("Encountered a case statement with no required-namespace"),c=!1);c?a=!0:$(this).remove()});a&&$("default",this).remove()})},addSwipeHandlers:function(a){var b=this;$(a).on("swipeleft",function(a){a.preventDefault();b.pages.goRight()});$(a).on("swiperight",function(a){a.preventDefault();b.pages.goLeft()})},injectMathJax:function(a){var b;b=a.contentDocument;if(a=b.getElementsByTagName("head")[0])b=
b.createElement("script"),b.type="text/javascript",b.src=MathJax.Hub.config.root+"/MathJax.js?config=readium-iframe",a.appendChild(b)},injectLinkHandler:function(a){var b=this;$("a",a.contentDocument).click(function(a){b.linkClickHandler(a)})},resetEl:function(){$("body").removeClass("apple-fixed-layout");$("#readium-book-view-el").attr("style","");this.$el.toggleClass("two-up",!1);this.$("#spine-divider").toggle(!1);this.zoomer.reset();$("#page-wrap").css({position:"relative",right:"0px",top:"0px",
"-webkit-transform":"scale(1.0) translate(0px, 0px)"})}});
Readium.Views.FixedPaginationView=Readium.Views.PaginationViewBase.extend({initialize:function(a){Readium.Views.PaginationViewBase.prototype.initialize.call(this,a);this.model.get("spine_position");this.model.on("FXL_goToPage",this.spinePositionChangeHandler,this);this.model.on("change:two_up",this.setUpMode,this);this.model.on("change:meta_size",this.setContainerSize,this)},render:function(){$("body").addClass("apple-fixed-layout");this.$("#container").html("");this.setContainerSize();this.setUpMode();
for(var a=this,c=1,b=this.findPrerenderStart(),d=[],e=this.model.get("spine_position");this.shouldPreRender(this.model.getCurrentSection(b));)this.addPage(this.model.getCurrentSection(b),c),d.push(e+b),c+=1,b+=1;b=d.indexOf(e)+1;this.pages.set("num_pages",c-1);this.pages.goToPage(b);setTimeout(function(){a.setContainerSize()},15);this.showCurrentPages();return d},getPageBody:function(a){a=$("#page-"+a.toString()+" iframe");return a.length>0?(a=a.contents()[0].documentElement,$(a).find("body")):null},
indicateMoIsPlaying:function(){(new Readium.Models.MediaOverlayViewHelper({epubController:this.model})).renderFixedMoPlaying(this.pages.get("current_page"),this.mediaOverlayController.get("active_mo"),this)},highlightText:function(){(new Readium.Models.MediaOverlayViewHelper({epubController:this.model})).renderFixedLayoutMoFragHighlight(this.pages.get("current_page"),this.mediaOverlayController.get("mo_text_id"),this)},destruct:function(){Readium.Views.PaginationViewBase.prototype.destruct.call(this);
this.model.off("change:two_up",this.setUpMode);this.model.off("change:meta_size",this.setUpMode)},spinePositionChangeHandler:function(){this.pages.goToPage(this.model.get("spine_position")+1)},addPage:function(a,c){var b=a.getPageView();b.on("iframe_loaded",function(){this.iframeLoadCallback({srcElement:b.iframe()})},this);var d=a.getPageView().render().el;$(d).attr("id","page-"+c.toString());this.$("#container").append(d);this.showCurrentPages();return this},setContainerSize:function(){var a=this.model.get("meta_size");
if(a&&(this.$el.width(a.width*2),this.$el.height(a.height),this.zoomer.fitToBest(),!this.zoomed))this.zoomed=!0},findPrerenderStart:function(){for(var a=0;this.shouldPreRender(this.model.getCurrentSection(a));)a-=1;return a+1},shouldPreRender:function(a){return a&&a.isFixedLayout()},showCurrentPages:function(){var a=this,c=new Readium.Models.MediaOverlayViewHelper({epubController:this.model});this.$(".fixed-page-wrap").each(function(b){$(this).toggle(a.pages.isPageVisible(b+1))});$.each(this.pages.get("current_page"),
function(){c.removeActiveClass(a.getPageBody(this.toString()))})},setFontSize:function(){var a=this.model.get("font_size")/10;$("#readium-content-container").css("font-size",a+"em");this.showCurrentPages()}});
Readium.Views.FixedPageView=Backbone.View.extend({className:"fixed-page-wrap",initialize:function(){this.template=Handlebars.templates.fixed_page_template;this.model.on("change",this.render,this)},destruct:function(){this.model.off("change",this.render)},render:function(){var a=this;this.$el.html(this.template(this.model.toJSON()));this.$el.addClass(this.model.getPageSpreadClass());this.$(".content-sandbox").on("load",function(){a.trigger("iframe_loaded")});return this},iframe:function(){return this.$(".content-sandbox")[0]}});
Readium.Views.ImagePageView=Backbone.View.extend({className:"fixed-page-wrap",initialize:function(){this.template=Handlebars.templates.image_page_template;this.model.on("change",this.render,this)},render:function(){var a=this;this.$el.html(this.template(this.model.toJSON()));this.$el.addClass(this.model.getPageSpreadClass());this.$("img").on("load",function(){a.setSize()});return this},setSize:function(){var a=this.$("img"),c=a.width(),a=a.height();c>0&&this.model.set({meta_width:c,meta_height:a})}});
Readium.Views.ReflowablePaginationView=Readium.Views.PaginationViewBase.extend({initialize:function(a){Readium.Views.PaginationViewBase.prototype.initialize.call(this,a);this.page_template=Handlebars.templates.reflowing_template;this.stashModernizrPrefixedProps();this.offset_dir=this.model.epub.get("page_prog_dir")==="rtl"?"right":"left";this.pages.on("change:current_page",this.pageChangeHandler,this);this.model.on("change:toc_visible",this.windowSizeChangeHandler,this);this.model.on("repagination_event",
this.windowSizeChangeHandler,this);this.model.on("change:current_theme",this.injectTheme,this);this.model.on("change:two_up",this.setUpMode,this);this.model.on("change:two_up",this.adjustIframeColumns,this);this.model.on("change:current_margin",this.marginCallback,this);this.model.on("change:hash_fragment",this.goToHashFragment,this)},render:function(a){var b=this,c=this.model.getCurrentSection().toJSON();this.setUpMode();this.$("#container").html(this.page_template(c));this.$("#readium-flowing-content").on("load",
function(c){b.adjustIframeColumns();b.iframeLoadCallback(c);b.setFontSize();b.injectTheme();b.setNumPages();a?b.pages.goToLastPage():b.pages.goToPage(1)});return[this.model.get("spine_position")]},findVisiblePageElements:function(){var a=$(this.getBody()).find("[id]"),b=$("#readium-flowing-content").contents()[0].documentElement,c=0+$(b).width(),b=0+$(b).height();return this.filterElementsByPosition(a,0,b,0,c)},filterElementsByPosition:function(a,b,c,e,f){return a.filter(function(){var a=$(this).offset().top,
d=$(this).offset().left,g=d+$(this).width(),h=a+$(this).height(),a=a>=b&&h<=c;return d>=e&&g<=f&&a})},indicateMoIsPlaying:function(){(new Readium.Models.MediaOverlayViewHelper({epubController:this.model})).renderReflowableMoPlaying(this.model.get("current_theme"),this.mediaOverlayController.get("active_mo"),this)},highlightText:function(){(new Readium.Models.MediaOverlayViewHelper({epubController:this.model})).renderReflowableMoFragHighlight(this.model.get("current_theme"),this,this.mediaOverlayController.get("mo_text_id"))},
destruct:function(){this.pages.off("change:current_page",this.pageChangeHandler);this.model.off("change:toc_visible",this.windowSizeChangeHandler);this.model.off("repagination_event",this.windowSizeChangeHandler);this.model.off("change:current_theme",this.windowSizeChangeHandler);this.model.off("change:two_up",this.setUpMode);this.model.off("change:two_up",this.adjustIframeColumns);this.model.off("change:current_margin",this.marginCallback);Readium.Views.PaginationViewBase.prototype.destruct.call(this)},
goToPage:function(a){if(!(this.model.get("current_page")!=void 0&&this.model.get("current_page").indexOf(a)!=-1)){var b=this.calcPageOffset(a).toString()+"px";$(this.getBody()).css(this.offset_dir,"-"+b);this.showContent();(this.model.get("two_up")==!1||this.model.get("two_up")&&a%2===1)&&this.mediaOverlayController.reflowPageChanged()}},goToHashFragment:function(){var a=this.model.get("hash_fragment");if(a&&(a=$("#"+a,this.getBody())[0])){for(;a.children.length>0;)a=a.children[0];a=this.getElemPageNumber(a);
a>0&&this.pages.goToPage(a)}},setFontSize:function(){var a=this.model.get("font_size")/10;$(this.getBody()).css("font-size",a+"em");this.setNumPages()},stashModernizrPrefixedProps:function(){var a=function(a){return a.replace(/([A-Z])/g,function(a,b){return"-"+b.toLowerCase()}).replace(/^ms-/,"-ms-")};this.columAxis=Modernizr.prefixed("columnAxis")||"columnAxis";this.columGap=Modernizr.prefixed("columnGap")||"columnGap";this.columWidth=Modernizr.prefixed("columnWidth")||"columnWidth";this.cssColumAxis=
a(this.columAxis);this.cssColumGap=a(this.columGap);this.cssColumWidth=a(this.columWidth)},getBodyColumnCss:function(){var a={};a[this.cssColumAxis]="horizontal";a[this.cssColumGap]=this.gap_width.toString()+"px";a[this.cssColumWidth]=this.page_width.toString()+"px";a.padding="0px";a.margin="0px";a.position="absolute";a.width=this.page_width.toString()+"px";a.height=this.frame_height.toString()+"px";return a},adjustIframeColumns:function(){var a=this.$("#readium-flowing-content");this.setFrameSize();
this.frame_width=parseInt(a.width(),10);this.frame_height=parseInt(a.height(),10);this.gap_width=Math.floor(this.frame_width/7);this.page_width=this.model.get("two_up")?Math.floor((this.frame_width-this.gap_width)/2):this.frame_width;$(this.getBody()).css(this.getBodyColumnCss());this.setNumPages();this.goToPage(this.pages.get("current_page")[0]||1)},getBody:function(){return this.$("#readium-flowing-content").contents()[0].documentElement},hideContent:function(){$("#flowing-wrapper").css("opacity",
"0")},showContent:function(){$("#flowing-wrapper").css("opacity","1")},calcPageOffset:function(a){return(a-1)*(this.page_width+this.gap_width)},setFrameSize:function(){var a=this.getFrameWidth().toString()+"px",b=this.getFrameHeight().toString()+"px";this.$("#readium-flowing-content").attr("width",a);this.$("#readium-flowing-content").attr("height",b);this.$("#readium-flowing-content").css("width",a);this.$("#readium-flowing-content").css("height",b)},getFrameWidth:function(){var a,b=this.model.get("current_margin");
b===1?this.model.get("two_up")?a=0.95:a=0.9:b===2?this.model.get("two_up")?a=0.89:a=0.8:b===3?this.model.get("two_up")?a=0.83:a=0.7:b===4?this.model.get("two_up")?a=0.77:a=0.6:this.model.get("two_up")?a=0.7:a=0.5;return Math.floor($("#flowing-wrapper").width()*a)},getFrameHeight:function(){return $("#flowing-wrapper").height()},calcNumPages:function(){var a,b,c;a=this.getBody();b=a.style[this.offset_dir];a.style[this.offset_dir]="0px";c=this.getBody().scrollWidth;a.style[this.offset_dir]=b;a=Math.floor((c+
this.gap_width)/(this.gap_width+this.page_width));a%2===0&&this.model.get("two_up");return a},getElemPageNumber:function(a){var b,a=a.getClientRects();if(!a||a.length<1)return-1;b=a[0][this.offset_dir];b+=Math.abs(a[0].left-a[0].right);this.offset_dir==="right"&&(b=this.page_width-b);b-=parseInt(this.getBody().style[this.offset_dir],10);return Math.ceil(b/(this.page_width+this.gap_width))},getElemPageNumberById:function(a){var b=$("#readium-flowing-content").contents()[0].documentElement,a=$(b).find("#"+
a);return a.length==0?-1:this.getElemPageNumber(a[0])},pageChangeHandler:function(){var a=this;this.hideContent();setTimeout(function(){a.goToPage(a.pages.get("current_page")[0])},150)},windowSizeChangeHandler:function(){this.adjustIframeColumns()},marginCallback:function(){this.adjustIframeColumns()},themes:{"default-theme":{"background-color":"white",color:"black","mo-color":"#777"},"vancouver-theme":{"background-color":"#DDD",color:"#576b96","mo-color":"#777"},"ballard-theme":{"background-color":"#576b96",
color:"#DDD","mo-color":"#888"},"parchment-theme":{"background-color":"#f7f1cf",color:"#774c27","mo-color":"#eebb22"},"night-theme":{"background-color":"#141414",color:"white","mo-color":"#666"}},injectTheme:function(){var a=this.model.get("current_theme");a==="default"&&(a="default-theme");$(this.getBody()).css({color:this.themes[a].color,"background-color":this.themes[a]["background-color"]});$("#flowing-wrapper").css("visibility","hidden");this.activateEPubStyle(this.getBody());setTimeout(function(){$("#flowing-wrapper").css("visibility",
"visible")},100)},setNumPages:function(){this.pages.set("num_pages",this.calcNumPages())}});
Readium.Views.ScrollingPaginationView=Readium.Views.PaginationViewBase.extend({initialize:function(a){Readium.Views.PaginationViewBase.prototype.initialize.call(this,a);this.page_template=Handlebars.templates.scrolling_page_template},render:function(){var a=this,b=this.model.getCurrentSection().toJSON();this.$("#container").html(this.page_template(b));this.$(".content-sandbox").on("load",function(b){a.iframeLoadCallback(b)});return[this.model.get("spine_position")]},destruct:function(){Readium.Views.PaginationViewBase.prototype.destruct.call(this)}});
Readium.Views.ToolbarView=Backbone.View.extend({el:"#toolbar-el",initialize:function(){this.model.on("change:toolbar_visible",this.renderBarVibility,this);this.model.on("change:full_screen",this.renderFullScreen,this);this.model.on("change:current_theme",this.renderThemeButton,this);this.model.on("change:spine_position",this.hideOrShowMoButton,this)},render:function(){this.renderBarVibility();this.renderFullScreen();this.renderThemeButton();return this},renderBarVibility:function(){var a=this.model.get("toolbar_visible");
this.$("#show-toolbar-button").toggle(!a);this.$("#top-bar").toggle(a);return this},renderFullScreen:function(){var a=this.model.get("full_screen");this.$("#go-to-fs-ico").toggle(!a);this.$("#leave-fs-ico").toggle(a);return this},renderThemeButton:function(){var a=this.model.get("current_theme")==="night-theme";this.$("#night-to-day-ico").toggle(a);this.$("#day-to-night-ico").toggle(!a);return this},hideOrShowMoButton:function(){this.model.getCurrentSection().hasMediaOverlay()?$("#play-mo-btn").show():
$("#play-mo-btn").hide()},events:{"click #hide-toolbar-button":"hide_toolbar","click #show-toolbar-button":"show_toolbar","click #fs-toggle-btn":"toggle_fs","click #toggle-toc-btn":"toggle_toc","click #nightmode-btn":"toggle_night_mode","click #play-mo-btn":"play_mo"},show_toolbar:function(a){a.preventDefault();this.model.set("toolbar_visible",!0)},hide_toolbar:function(a){a.preventDefault();this.model.set("toolbar_visible",!1)},toggle_fs:function(a){a.preventDefault();this.model.toggleFullScreen()},
toggle_toc:function(a){a.preventDefault();this.model.toggleToc()},toggle_night_mode:function(){this.model.get("current_theme")==="night-theme"?this.model.set("current_theme","default-theme"):this.model.set("current_theme","night-theme");this.model.save()},play_mo:function(){var a=this.model.get("media_overlay_controller");a.get("active_mo")?a.pauseMo():a.playMo()}});
Readium.Views.TocViewBase=Backbone.View.extend({el:"#readium-toc",initialize:function(){this.model.on("change",this.render,this);this.model.on("change:visible",this.setVisibility,this)},events:{"click a":"handleClick","click #close-toc-button":"closeToc"},setVisibility:function(){this.$el.toggle(this.model.get("visible"))},handleClick:function(a){a.preventDefault();href=$(a.currentTarget).attr("href");this.model.handleLink(href)},closeToc:function(a){a.preventDefault();this.model.hide()}});
Readium.Views.NcxTocView=Readium.Views.TocViewBase.extend({initialize:function(){Readium.Views.TocViewBase.prototype.initialize.call(this);this.nav_template=Handlebars.templates.ncx_nav_template},render:function(){this.setVisibility();for(var a=$("<ol></ol>"),c=this.model.get("navs"),b=0;b<c.length;b++)a.append(this.nav_template(c[b]));this.$("#toc-body").html("<h2>"+(this.model.get("title")||"Contents")+"</h2>");this.$("#toc-body").append(a);this.$("#toc-body").append("<div id='toc-end-spacer'>");
return this}});Readium.Views.XhtmlTocView=Readium.Views.TocViewBase.extend({render:function(){this.$("#toc-body").html(this.model.get("body").html());this.$("#toc-body").append("<div id='toc-end-spacer'>");return this}});
Readium.Views.OptionsView=Backbone.View.extend({el:"#viewer-settings-modal",initialize:function(){this.model.on("change:current_theme",this.renderTheme,this);this.model.on("change:two_up",this.renderUpMode,this);this.model.on("change:current_margin",this.renderMarginRadio,this);this.model.on("change:font_size",this.renderFontSize,this)},render:function(){this.renderTheme();this.renderUpMode();this.renderMarginRadio();this.renderFontSize();return this},renderTheme:function(){this.$("#preview-text")[0].className=
this.model.get("current_theme");return this},renderUpMode:function(){var a=this.model.get("two_up");this.$("#one-up-option").toggleClass("selected",!a);this.$("#two-up-option").toggleClass("selected",a);return this},renderMarginRadio:function(){var a="#margin-option-"+this.model.get("current_margin");this.$(".margin-radio").toggleClass("selected",!1);this.$(a).toggleClass("selected",!0);return this},renderFontSize:function(){var a=this.model.get("font_size"),b=(a/10).toString()+"em";this.$("#preview-text").css("font-size",
b);this.$("#font-size-input").val(a)},events:{"click .theme-option":"selectTheme","click .margin-radio":"selectMargin","click #cancel-settings-but":"cancelSettings","click #save-settings-but":"applySettings","change #font-size-input":"extractFontSize","click #one-up-option":function(){this.model.set("two_up",!1)},"click #two-up-option":function(){this.model.set("two_up",!0)}},extractFontSize:function(){var a=$("#font-size-input").val(),a=parseInt(a,10);this.model.set("font_size",a)},selectTheme:function(a){a=
a.srcElement.id;a==="default-theme-option"&&this.model.set("current_theme","default-theme");a==="night-theme-option"&&this.model.set("current_theme","night-theme");a==="parchment-theme-option"&&this.model.set("current_theme","parchment-theme");a==="ballard-theme-option"&&this.model.set("current_theme","ballard-theme");a==="vancouver-theme-option"&&this.model.set("current_theme","vancouver-theme")},selectMargin:function(a){a=a.srcElement.id;a=a[a.length-1];a==="1"&&this.model.set("current_margin",
1);a==="2"&&this.model.set("current_margin",2);a==="3"&&this.model.set("current_margin",3);a==="4"&&this.model.set("current_margin",4);a==="5"&&this.model.set("current_margin",5)},cancelSettings:function(){this.$el.modal("hide");this.model.resetOptions()},applySettings:function(){this.model.applyOptions();this.$el.modal("hide")}});
Readium.Views.FixedLayoutBookZoomer=Backbone.View.extend({el:"#readium-right-content",horizontalPad:30,verticalPad:30,initialize:function(){this.zoomingModel=new Readium.Models.FixedLayoutBookZoomingModel},render:function(){this.$("#page-wrap").css(this.zoomingModel.getCSSProperties());return this},reset:function(){this.zoomingModel.setDefaults();this.render()},fitToBest:function(){var a=this.fitToWidthScale(),b=this.fitToHeightScale();a<b?this.applyScale(a):this.applyScale(b)},fitToWidth:function(){this.applyScale(this.fitToWidthScale())},
fitToHeight:function(){this.applyScale(this.fitToHeightScale())},fitToWidthScale:function(){return(this.containerWidth()-this.horizontalPad)/this.bookWidth()},fitToHeightScale:function(){return(this.containerHeight()-this.verticalPad)/this.bookHeight()},applyScale:function(a){this.zoomingModel.set("scale",a);this.zoomingModel.set("leftShift",this.leftShift(a));this.zoomingModel.set("topShift",this.verticalPad/2);this.render()},leftShift:function(a){return(this.containerWidth()-this.bookWidth()*a)/
2},containerWidth:function(){return this.$el.width()},containerHeight:function(){return this.$el.height()},bookWidth:function(){return this.$("#page-wrap").width()},bookHeight:function(){return this.$("#page-wrap").height()}});
Readium.Models.FixedLayoutBookZoomingModel=Backbone.Model.extend({initialize:function(){this.styleAttrs=this.getModernizedAttrs()},defaults:{scale:1,leftShift:0,topShift:0},setDefaults:function(){this.set(this.defaults)},getModernizedAttrs:function(){var a={};a.transform=this.modernizrCssPrefix("transform");a.transformOrigin=this.modernizrCssPrefix("transformOrigin");return a},modernizrCssPrefix:function(a){return Modernizr.prefixed(a).replace(/([A-Z])/g,function(a,c){return"-"+c.toLowerCase()}).replace(/^ms-/,
"-ms-")},getCSSProperties:function(){var a={};a[this.styleAttrs.transform]=this.getTransformString();a[this.styleAttrs.transformOrigin]="0 0";return a},getTransformString:function(){str="";str+="translate("+this.get("leftShift")+"px, "+this.get("topShift")+"px) ";str+="scale("+this.get("scale").toString()+")";return str}});
Readium.Views.ViewerApplicationView=Backbone.View.extend({el:"body",uiVisible:!1,initialize:function(){this.model.on("change:full_screen",this.toggleFullscreen,this);this.model.on("change:current_theme",this.renderTheme,this);this.model.on("change:toolbar_visible",this.renderPageButtons,this);this.model.on("change:toc_visible",this.renderTocVisible,this);this.optionsPresenter=new Readium.Models.OptionsPresenter({book:this.model});this.optionsView=new Readium.Views.OptionsView({model:this.optionsPresenter});
this.optionsView.render();this.toolbar=new Readium.Views.ToolbarView({model:_epubController});this.toolbar.render();this.model.on("change:has_toc",this.init_toc,this);this.addGlobalEventHandlers()},toggleFullscreen:function(){this.model.get("full_screen")?document.documentElement.webkitRequestFullScreen():document.webkitCancelFullScreen()},addGlobalEventHandlers:function(){var a=this.model,b=this;window.onresize=function(){a.trigger("repagination_event")};$(document).keydown(function(a){a.which==
39&&b.model.paginator.v.pages.goRight();a.which==37&&b.model.paginator.v.pages.goLeft()});$("#readium-book-view-el").on("swipeleft",function(a){a.preventDefault();b.model.paginator.v.pages.goRight()});$("#readium-book-view-el").on("swiperight",function(a){a.preventDefault();b.model.paginator.v.pages.goLeft()})},render:function(){this.renderTheme();this.renderPageButtons();this.renderTocVisible();return this},renderPageButtons:function(){var a=this.model.get("toolbar_visible");this.$("#prev-page-button").toggle(a);
this.$("#next-page-button").toggle(a);return this},renderTheme:function(){var a=this.model.get("current_theme");this.$el.toggleClass("default-theme","default-theme"===a);this.$el.toggleClass("night-theme","night-theme"===a);this.$el.toggleClass("parchment-theme","parchment-theme"===a);this.$el.toggleClass("ballard-theme","ballard-theme"===a);this.$el.toggleClass("vancouver-theme","vancouver-theme"===a);this.$("#readium-book-view-el").toggleClass("default-theme","default-theme"===a);this.$("#readium-book-view-el").toggleClass("night-theme",
"night-theme"===a);this.$("#readium-book-view-el").toggleClass("parchment-theme","parchment-theme"===a);this.$("#readium-book-view-el").toggleClass("ballard-theme","ballard-theme"===a);this.$("#readium-book-view-el").toggleClass("vancouver-theme","vancouver-theme"===a)},renderTocVisible:function(){this.$el.toggleClass("show-readium-toc",this.model.get("toc_visible"));return this},init_toc:function(){if(this.model.get("has_toc")){var a=this.model.getToc();this.toc=a.TocView();a.fetch()}},events:{"click #prev-page-button":function(){this.model.paginator.v.pages.goLeft()},
"click #next-page-button":function(){this.model.paginator.v.pages.goRight()}}});
Readium.Routers.ViewerRouter=Backbone.Router.extend({routes:{"views/viewer.html?book=:key":"openBook","*splat":"splat_handler"},openBook:function(a){var b=a+"_epubViewProperties";Lawnchair(function(){this.get(a,function(a){a===null?alert("Could not load ePUB, try refeshing your browser."):(window._epub=new Readium.Models.EPUB(a),this.get(b,function(a){window._epubController=new Readium.Models.EPUBController(_.extend({epub:window._epub},a));window._applicationView=new Readium.Views.ViewerApplicationView({model:window._epubController});
window._applicationView.render()}))})})},splat_handler:function(a){console.log(a)}});
Readium.Models.EPUB=Backbone.Model.extend({defaults:{can_two_up:!0},initialize:function(){this.packageDocument=new Readium.Models.PackageDocument({book:this,file_path:this.get("package_doc_path")})},getPackageDocument:function(){return this.packageDocument},toJSON:function(){return{apple_fixed:this.get("apple_fixed"),author:this.get("author"),cover_href:this.get("cover_href"),created_at:this.get("created_at"),description:this.get("description"),epub_version:this.get("epub_version"),fixed_layout:this.get("fixed_layout"),
id:this.get("id"),key:this.get("key"),language:this.get("language"),layout:this.get("layout"),modified_date:this.get("modified_date"),ncx:this.get("ncx"),open_to_spread:this.get("open_to_spread"),orientation:this.get("orientation"),package_doc_path:this.get("package_doc_path"),page_prog_dir:this.get("page_prog_dir"),paginate_backwards:this.get("paginate_backwards"),pubdate:this.get("pubdate"),publisher:this.get("publisher"),rights:this.get("rights"),spread:this.get("spread"),src_url:this.get("src_url"),
title:this.get("title")}},resolvePath:function(a){return this.packageDocument.resolvePath(a)},isFixedLayout:function(){return this.get("fixed_layout")||this.get("apple_fixed")}});
Readium.Models.PageNumberDisplayLogic=Backbone.Model.extend({initialize:function(){},getGotoPageNumsToDisplay:function(a,b,d,e){return b?d?e==="rtl"?this.displayedPageIsLeft(a)?[a-1,a]:this.displayedPageIsRight(a)?[a,a+1]:[a]:this.displayedPageIsLeft(a)?[a,a+1]:this.displayedPageIsRight(a)?[a-1,a]:[a]:a%2===1?[a,a+1]:[a-1,a]:[a]},getPrevPageNumsToDisplay:function(a,b,d){return b?d==="rtl"?this.displayedPageIsLeft(a)&&this.displayedPageIsRight(a-1)?[a-1,a]:[a]:this.displayedPageIsRight(a)&&this.displayedPageIsLeft(a-
1)?[a-1,a]:[a]:[a-1,a]},getNextPageNumsToDisplay:function(a,b,d){return b?d==="rtl"?this.displayedPageIsRight(a)&&this.displayedPageIsLeft(a+1)?[a,a+1]:[a]:this.displayedPageIsLeft(a)&&this.displayedPageIsRight(a+1)?[a,a+1]:[a]:[a,a+1]},getPageNumbersForTwoUp:function(a,b,d,e){var c=[];a?c[0]=b[0]===0?1:b[0]:e?d==="rtl"?this.displayedPageIsLeft(b[0])?(c[0]=b[0]-1,c[1]=b[0]):this.displayedPageIsRight(b[0])&&(c[0]=b[0],c[1]=b[0]+1):this.displayedPageIsLeft(b[0])?(c[0]=b[0],c[1]=b[0]+1):this.displayedPageIsRight(b[0])&&
(c[0]=b[0]-1,c[1]=b[0]):b[0]%2===1?(c[0]=b[0],c[1]=b[0]+1):(c[0]=b[0]-1,c[1]=b[0]);return c},displayedPageIsRight:function(a){return $("#page-"+a).hasClass("right_page")?!0:!1},displayedPageIsLeft:function(a){return $("#page-"+a).hasClass("left_page")?!0:!1},displayedPageIsCenter:function(a){return $("#page-"+a).hasClass("center_page")?!0:!1}});
Readium.Models.ReadiumPagination=Backbone.Model.extend({defaults:{num_pages:0},initialize:function(){this.epubController=this.get("model");this.set("current_page",[this.epubController.get("spine_position")+1]);this.pageNumberDisplayLogic=new Readium.Models.PageNumberDisplayLogic;this.on("change:num_pages",this.adjustCurrentPage,this)},toggleTwoUp:function(){this.epubController.get("can_two_up")&&this.set({current_page:this.pageNumberDisplayLogic.getPageNumbersForTwoUp(this.epubController.get("two_up"),
this.get("current_page"),this.epubController.epub.get("page_prog_dir"),this.epubController.getCurrentSection().isFixedLayout())})},goRight:function(){this.epubController.epub.get("page_prog_dir")==="rtl"?this.prevPage():this.nextPage()},goLeft:function(){this.epubController.epub.get("page_prog_dir")==="rtl"?this.nextPage():this.prevPage()},goToPage:function(a){this.set("current_page",this.pageNumberDisplayLogic.getGotoPageNumsToDisplay(a,this.epubController.get("two_up"),this.epubController.getCurrentSection().isFixedLayout(),
this.epubController.epub.get("page_prog_dir")))},isPageVisible:function(a){return this.get("current_page").indexOf(a)!==-1},prevPage:function(){var a=this.get("current_page"),b=a[0]-1;a[0]<=1?this.epubController.goToPrevSection():this.epubController.paginator.shouldScroll()&&!this.epubController.getCurrentSection().isFixedLayout()?this.epubController.goToPrevSection():this.epubController.get("two_up")?(this.set("current_page",this.pageNumberDisplayLogic.getPrevPageNumsToDisplay(b,this.epubController.getCurrentSection().isFixedLayout(),
this.epubController.epub.get("page_prog_dir"))),this.epubController.get("rendered_spine_items").length>1&&(a=this.epubController.get("rendered_spine_items")[b>1?b-2:0],this.epubController.set("spine_position",a))):(this.set("current_page",[b]),this.epubController.get("rendered_spine_items").length>1&&(a=this.epubController.get("rendered_spine_items")[b-1],this.epubController.set("spine_position",a)))},nextPage:function(){var a=this.get("current_page"),b=a[a.length-1]+1;a[a.length-1]>=this.get("num_pages")?
this.epubController.goToNextSection():(this.epubController.get("two_up")?this.set("current_page",this.pageNumberDisplayLogic.getNextPageNumsToDisplay(b,this.epubController.getCurrentSection().isFixedLayout(),this.epubController.epub.get("page_prog_dir"))):this.set("current_page",[b]),this.epubController.get("rendered_spine_items").length>1&&(a=this.epubController.get("rendered_spine_items")[b-1],this.epubController.set("spine_position",a)))},adjustCurrentPage:function(){var a=this.get("current_page"),
b=this.get("num_pages");this.epubController.get("two_up");a[a.length-1]>b&&this.goToLastPage()},goToLastPage:function(){this.goToPage(this.get("num_pages"))}});
(function(){var h=Handlebars.template,i=Handlebars.templates=Handlebars.templates||{};i.binding_template=h(function(){return'<iframe scrolling="no" \n\t\tframeborder="0" \n\t\tmarginwidth="0" \n\t\tmarginheight="0" \n\t\twidth="100%" \n\t\theight="100%" \n\t\tclass=\'binding-sandbox\'>\n</iframe>'});i.extracting_item_template=h(function(e,b,d){var d=d||e.helpers,e="",a,c=d.helperMissing,f=this.escapeExpression;e+="<h5>";a=(a=d.log_message)||b.log_message;typeof a==="function"?a=a.call(b,{hash:{}}):
a===void 0&&(a=c.call(b,"log_message",{hash:{}}));e+=f(a)+'</h5>\n<div class="progress progress-striped progress-success active ">\t\n\t\t<div role="status" aria-live="assertive" aria-relevant="all" class="bar" style="width: ';a=(a=d.progress)||b.progress;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=c.call(b,"progress",{hash:{}}));e+=f(a)+'%;"></div>\n</div>';return e});i.fixed_page_template=h(function(e,b,d){var d=d||e.helpers,e="",a,c=d.helperMissing,f=this.escapeExpression;e+='<div class="fixed-page-margin">\n\t<iframe scrolling="no" \n\t\t\tframeborder="0" \n\t\t\tmarginwidth="0" \n\t\t\tmarginheight="0" \n\t\t\twidth="';
a=(a=d.width)||b.width;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=c.call(b,"width",{hash:{}}));e+=f(a)+'px" \n\t\t\theight="';a=(a=d.height)||b.height;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=c.call(b,"height",{hash:{}}));e+=f(a)+'px" \n\t\t\tsrc="';a=(a=d.uri)||b.uri;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=c.call(b,"uri",{hash:{}}));e+=f(a)+"\"\n\t\t\tclass='content-sandbox'>\n\t</iframe>\n</div>";return e});i.image_page_template=h(function(e,
b,d){var d=d||e.helpers,e="",a=d.helperMissing,c=this.escapeExpression;e+='<div class="fixed-page-margin">\n\t<img src="';d=d.uri||b.uri;typeof d==="function"?d=d.call(b,{hash:{}}):d===void 0&&(d=a.call(b,"uri",{hash:{}}));e+=c(d)+'" >\n</div>';return e});i.library_item_template=h(function(e,b,d){var d=d||e.helpers,e="",a,c,f=d.helperMissing,g=this.escapeExpression;e+="<div class='info-wrap clearfix'>\n\t<div class='caption book-info'>\n\t\t<h2 class='green info-item title'>";a=(c=d.data)||b.data;
a=a===null||a===void 0||a===!1?a:a.title;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=f.call(b,"data.title",{hash:{}}));e+=g(a)+"</h2>\n\t\t<div class='info-item author'>";a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.author;c=(c=d.orUnknown)||b.orUnknown;a=typeof c==="function"?c.call(b,a,{hash:{}}):c===void 0?f.call(b,"orUnknown",a,{hash:{}}):c;e+=g(a)+"</div>\n\t\t<div class='info-item epub-version'>ePUB ";a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.epub_version;
c=(c=d.orUnknown)||b.orUnknown;a=typeof c==="function"?c.call(b,a,{hash:{}}):c===void 0?f.call(b,"orUnknown",a,{hash:{}}):c;e+=g(a)+"</div>\n\t\t\n\t</div>\n\t\n\t<img class='cover-image read' src='";a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.cover_href;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=f.call(b,"data.cover_href",{hash:{}}));e+=g(a)+"' width='150' height='220' alt='Open ePUB ";a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.title;typeof a==="function"?
a=a.call(b,{hash:{}}):a===void 0&&(a=f.call(b,"data.title",{hash:{}}));e+=g(a)+"'>\n\t\n\t<a href=\"#details-modal-";a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.key;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=f.call(b,"data.key",{hash:{}}));e+=g(a)+'" class="info-icon" data-toggle="modal" role="button">\n\t\t<img class=\'info-icon pull-right\' src=\'/images/library/info-icon.png\' height="39px" width="39px" alt=\'';a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.title;
typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=f.call(b,"data.title",{hash:{}}));e+=g(a)+' information\'>\n\t</a>\n</div>\n\n<div class="caption clearfix buttons">\n\t<a href="#todo" class="btn read" data-book=\'';a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.key;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=f.call(b,"data.key",{hash:{}}));e+=g(a)+"' role='button'>Read</a>\n\t<a href=\"#details-modal-";a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.key;
typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=f.call(b,"data.key",{hash:{}}));e+=g(a)+'" class="btn details" data-toggle="modal" role="button">\n\t\tDetails\n\t</a>\n</div>\n\n<div id=\'details-modal-';a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.key;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=f.call(b,"data.key",{hash:{}}));e+=g(a)+"' class='modal fade details-modal'>\n\t<div class=\"pull-left modal-cover-wrap\">\n\t\t<img class='details-cover-image' src='";
a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.cover_href;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=f.call(b,"data.cover_href",{hash:{}}));e+=g(a)+"' width='150' height='220' alt='ePUB cover'>\n\t\t<div class=\"caption clearfix modal-buttons\">\n\t\t\t<a href=\"#\" class=\"btn read\" data-book='<%= data.key %>' role='button'>Read</a>\n\t\t\t<a class=\"btn btn-danger delete pull-right\" role='button'>Delete</a>\n\t\t</div>\n\t</div>\n\t<div class='caption modal-book-info'>\n\t\t<h3 class='green modal-title'>";
a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.title;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=f.call(b,"data.title",{hash:{}}));e+=g(a)+"</h3>\n\t\t<div class='modal-detail gap'>Author: ";a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.author;c=(c=d.orUnknown)||b.orUnknown;a=typeof c==="function"?c.call(b,a,{hash:{}}):c===void 0?f.call(b,"orUnknown",a,{hash:{}}):c;e+=g(a)+"</div>\n\t\t<div class='modal-detail'>Publisher: ";a=(c=d.data)||b.data;a=a===null||a===void 0||
a===!1?a:a.publisher;c=(c=d.orUnknown)||b.orUnknown;a=typeof c==="function"?c.call(b,a,{hash:{}}):c===void 0?f.call(b,"orUnknown",a,{hash:{}}):c;e+=g(a)+"</div>\n\t\t<div class='modal-detail'>Pub Date: ";a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.pubdate;c=(c=d.orUnknown)||b.orUnknown;a=typeof c==="function"?c.call(b,a,{hash:{}}):c===void 0?f.call(b,"orUnknown",a,{hash:{}}):c;e+=g(a)+"</div>\n\t\t<div class='modal-detail'>Modified Date: ";a=(c=d.data)||b.data;a=a===null||a===void 0||
a===!1?a:a.modified_date;c=(c=d.orUnknown)||b.orUnknown;a=typeof c==="function"?c.call(b,a,{hash:{}}):c===void 0?f.call(b,"orUnknown",a,{hash:{}}):c;e+=g(a)+"</div>\n\t\t<div class='modal-detail gap'>ID: ";a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.id;c=(c=d.orUnknown)||b.orUnknown;a=typeof c==="function"?c.call(b,a,{hash:{}}):c===void 0?f.call(b,"orUnknown",a,{hash:{}}):c;e+=g(a)+"</div>\n\t\t<div class='modal-detail green'>Format: ePUB ";a=(c=d.data)||b.data;a=a===null||a===void 0||
a===!1?a:a.epub_version;c=(c=d.orUnknown)||b.orUnknown;a=typeof c==="function"?c.call(b,a,{hash:{}}):c===void 0?f.call(b,"orUnknown",a,{hash:{}}):c;e+=g(a)+"</div>\n\t\t<div class='modal-detail'>Added: ";a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.created_at;c=(c=d.orUnknown)||b.orUnknown;a=typeof c==="function"?c.call(b,a,{hash:{}}):c===void 0?f.call(b,"orUnknown",a,{hash:{}}):c;e+=g(a)+"</div>\n\t</div>\n\t<div class='modal-detail source'>\n\t<span class='green' style=\"padding-right: 10px\">Source:</span>\n\t\t";
a=(c=d.data)||b.data;a=a===null||a===void 0||a===!1?a:a.src_url;c=(c=d.orUnknown)||b.orUnknown;a=typeof c==="function"?c.call(b,a,{hash:{}}):c===void 0?f.call(b,"orUnknown",a,{hash:{}}):c;e+=g(a)+"\n\t</div>\n</div>\t\t\t";return e});i.library_items_template=h(function(){return"<div id='empty-message'>\n\t<p id='empty-message-text' class='green'>\n\t\tAdd items to your</br>library here!\n\t</p>\n\t<img id='empty-arrow' src='/images/library/empty_library_arrow.png' alt='' />\n</div>"});i.ncx_nav_template=
h(function(e,b,d){var d=d||e.helpers,e="",a,c=d.helperMissing,f=this.escapeExpression;e+='<li class="nav-elem">\n\t<a href="';a=(a=d.href)||b.href;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=c.call(b,"href",{hash:{}}));e+=f(a)+'">';a=(a=d.text)||b.text;typeof a==="function"?a=a.call(b,{hash:{}}):a===void 0&&(a=c.call(b,"text",{hash:{}}));e+=f(a)+"</a>\n</li>";return e});i.reflowing_template=h(function(e,b,d){var d=d||e.helpers,e="",a=d.helperMissing,c=this.escapeExpression;e+='<div id="flowing-wrapper">\n\t<iframe scrolling="no" \n\t\t\tframeborder="0" \n\t\t\tmarginwidth="0" \n\t\t\tmarginheight="0" \n\t\t\twidth="50%" \n\t\t\theight="100%" \n\t\t\tsrc="';
d=d.uri||b.uri;typeof d==="function"?d=d.call(b,{hash:{}}):d===void 0&&(d=a.call(b,"uri",{hash:{}}));e+=c(d)+'"\n\t\t\tid="readium-flowing-content">\n\t</iframe>\n</div>';return e});i.scrolling_page_template=h(function(e,b,d){var d=d||e.helpers,e="",a=d.helperMissing,c=this.escapeExpression;e+='<div id="scrolling-content" class="scrolling-page-wrap">\n\t<div class="scrolling-page-margin">\n\n\t\t<iframe scrolling="yes" \n\t\t\t\tframeborder="0" \n\t\t\t\tmarginwidth="0" \n\t\t\t\tmarginheight="0" \n\t\t\t\twidth="100%" \n\t\t\t\theight="100%" \n\t\t\t\tsrc="';
d=d.uri||b.uri;typeof d==="function"?d=d.call(b,{hash:{}}):d===void 0&&(d=a.call(b,"uri",{hash:{}}));e+=c(d)+"\"\n\t\t\t\tclass='content-sandbox'>\n\t\t</iframe>\n\t</div>\n</div>";return e})})();
Readium.Models.MediaOverlayController=Backbone.Model.extend({defaults:{active_mo:null,mo_text_id:null},initialize:function(){this.currentSection=this.mo=null;this.processingMoTextSrc=this.autoplayNextSpineItem=!1;this.currentView=this.pages=this.moTargetNode=null;this.epubController=this.get("epubController");this.epubController.on("change:spine_position",this.handleSpineChanged,this)},setPages:function(a){this.pages!=null&&this.pages.off();this.pages=a},setView:function(a){this.currentView=a},playMo:function(){if(this.mo==
null)alert("Sorry, there is no audio for this section.");else{this.set("active_mo",this.mo);this.mo.on("change:current_text_src",this.handleMoTextSrc,this);this.mo.on("change:is_document_done",this.handleMoDocumentDone,this);var a=this.moTargetNode;this.moTargetNode=null;if(this.currentSection.isFixedLayout())this.mo.get("has_started_playback")?this.resumeMo():this.mo.startPlayback(null);else{var b=-1,c=this.get("mo_text_id");c!=null&&c!=void 0&&c!=""&&(b=this.currentView.getElemPageNumberById(c));
this.pages.get("current_page").indexOf(b)!=-1?this.resumeMo():this.mo.startPlayback(a)}}},pauseMo:function(){this.mo&&(this.mo.off(),this.mo.pause(),this.set("active_mo",null))},reflowPageChanged:function(){if(!this.processingMoTextSrc&&!this.autoplayNextSpineItem){var a=this.get("active_mo")!=null;a&&this.pauseMo();this.setMoTarget();a&&this.playMo()}},pagesLoaded:function(){if(!this.currentSection.isFixedLayout()&&this.autoplayNextSpineItem==!0)this.autoplayNextSpineItem=!1,this.playMo()},resumeMo:function(){this.set("mo_text_id",
null);this.handleMoTextSrc();this.mo.resume()},handleMoTextSrc:function(){var a=this.mo.get("current_text_src");if(a==null)this.set("mo_text_id",null);else{this.processingMoTextSrc=!0;this.epubController.goToHref(a);var b="";a.indexOf("#")!=-1&&a.indexOf("#")<a.length-1&&(b=a.substr(a.indexOf("#")+1));this.set("mo_text_id",b);this.processingMoTextSrc=!1}},handleMoDocumentDone:function(){if(!(this.mo!=null&&this.mo!=void 0&&this.mo.get("is_document_done")==!1)&&(this.moTargetNode=null,this.pauseMo(),
this.epubController.hasNextSection()))this.autoplayNextSpineItem=!0,this.epubController.goToNextSection()},handleSpineChanged:function(){this.set("mo_text_id",null);if(this.epubController.getCurrentSection()!=this.currentSection){if(this.get("active_mo")!=null)this.autoplayNextSpineItem=!0,this.pauseMo();this.currentSection=this.epubController.getCurrentSection();this.mo=this.currentSection.getMediaOverlay();if(this.mo!=null&&(this.mo.reset(),this.currentSection.isFixedLayout()&&this.autoplayNextSpineItem))this.autoplayNextSpineItem=
!1,this.playMo()}},setMoTarget:function(){var a,b;if(this.mo!=null)if(this.currentSection.isFixedLayout())this.moTargetNode=null;else{a=this.currentView.findVisiblePageElements();var c=this.currentSection.get("href");b=null;console.log("\nVisible");for(var d=0;d<a.length;d++)if(b=$(a[d]).attr("id"),console.log(b),b=this.mo.findNodeByTextSrc(c+"#"+b))break;this.moTargetNode=b}}});
Readium.Models.MediaOverlayViewHelper=Backbone.Model.extend({initialize:function(){this.epubController=this.get("epubController")},addActiveClass:function(a){var c=this.getActiveClass();a.toggleClass(c,!0)},removeActiveClass:function(a){if(a!=null&&a!=void 0){var c=this.getActiveClass(),a=$(a).find("."+c);a.toggleClass(c,!1);return a}return null},renderFixedLayoutMoFragHighlight:function(a,c,b){var d=this;$.each(a,function(){var a=b.getPageBody(this);d.removeActiveClass(a)});c&&$.each(a,function(){var a=
b.getPageBody(this);(a=$(a).find("#"+c))&&d.addActiveClass(a)})},renderFixedMoPlaying:function(a,c,b){var d=this;this.authorActiveClassExists()&&(c||$.each(a,function(){var a=b.getPageBody(this);d.removeActiveClass(a)}))},renderReflowableMoFragHighlight:function(a,c,b){a==="default"&&(a="default-theme");var d=c.getBody(),e=this.removeActiveClass(d);this.authorActiveClassExists()==!1&&e&&$(e).css("color","");if(b&&(b=$(d).find("#"+b)))this.addActiveClass(b),this.authorActiveClassExists()==!1&&$(b).css("color",
c.themes[a].color)},renderReflowableMoPlaying:function(a,c,b){if(this.authorActiveClassExists()){if(!c)var d=b.getBody(),a=this.removeActiveClass(d)}else a==="default"&&(a="default-theme"),d=b.getBody(),c?$(d).css("color",b.themes[a]["mo-color"]):($(d).css("color",b.themes[a].color),(a=this.removeActiveClass(b.getBody()))&&$(a).css("color",""))},getActiveClass:function(){var a=this.epubController.packageDocument.get("metadata").active_class;a==""&&(a="-readium-epub-media-overlay-active");return a},
authorActiveClassExists:function(){return this.epubController.packageDocument.get("metadata").active_class==""?!1:!0}});
